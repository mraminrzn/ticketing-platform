
# 📄 مستندات پایگاه داده MongoDB برای سیستم چت

این سند به تشریح کامل ساختار کالکشن‌ها، مفاهیم کلیدی و مدل‌سازی داده‌ها در MongoDB می‌پردازد.

## 👤 کاربران، دپارتمان‌ها و کنترل دسترسی

اساس سیستم بر پایه داکیومنت‌های **کاربران** و نحوه تعامل آن‌ها با سیستم بنا شده است.

### داکیومنت یکپارچه کاربر (Unified User Document)

موجودیت اصلی سیستم، کالکشن `users` است. به جای چندین جدول، هر کاربر یک داکیومنت جامع دارد که تمام اطلاعات مرتبط با او را در خود جای داده است:

1.  **اطلاعات پایه:** فیلدهایی مانند `email` و `status` مستقیماً در داکیومنت ذخیره می‌شوند.
2.  **ویژگی‌ها (Attributes):** به جای جدول جداگانه، یک آبجکت تو در تو به نام `attributes` داریم. این ساختار انعطاف‌پذیر به ما اجازه می‌دهد بی‌نهایت ویژگی کلید-مقدار (مانند `job_title`) به کاربر اضافه کنیم.
3.  **دپارتمان‌ها (Departments):** کاربران از طریق یک آرایه از شناسه‌ها به نام `department_ids` به کالکشن `departments` ارجاع داده می‌شوند.
4.  **جلسات (Sessions):** توکن‌های احراز هویت هر کاربر در یک آرایه تو در تو به نام `sessions` درون داکیومنت خود کاربر ذخیره می‌شود.

### احراز هویت و کنترل دسترسی مبتنی بر ویژگی (ABAC)

این مدل داده برای پیاده‌سازی **کنترل دسترسی مبتنی بر ویژگی (ABAC)** ایده‌آل است. مجوزها بر اساس فیلدهای موجود در آبجکت `attributes` هر کاربر تعیین می‌شود. برای مثال، اگر کاربری فیلد `attributes.canCloseTicket` با مقدار `true` را داشته باشد، سیستم به او اجازه بستن تیکت را می‌دهد.

## 💬 سیستم ارتباطی: کالکشن Chats

### داکیومنت چت (Chat Document)

کالکشن `chats` قلب سیستم ارتباطی است. هر داکیومنت در این کالکشن، یک مکالمه کامل را در خود نگه می‌دارد. یک فیلد کلیدی به نام `type`، ماهیت مکالمه را مشخص می‌کند:

*   `type = 'CHAT'`: یک گفتگوی زنده و آنی.
*   `type = 'TICKET'`: یک درخواست پشتیبانی رسمی با قابلیت پیگیری.

### پیام‌های تو در تو (Embedded Messages)

به جای یک جدول جداگانه، تمام پیام‌های یک مکالمه در یک آرایه به نام `messages` درون همان داکیومنت چت ذخیره می‌شوند. این مدل‌سازی مزیت اصلی MongoDB برای این سیستم است، زیرا برای بازیابی کل تاریخچه یک چت، تنها یک کوئری لازم است.

## 🗂️ مرجع کامل کالکشن‌ها

### 👤 کالکشن کاربران (users)

این کالکشن شامل تمام اطلاعات کاربران، ویژگی‌ها و نشست‌های آن‌هاست.

```

{
  "_id": ObjectId("..."),
  "email": "user@example.com",
  "hashPassword": "...",
  "status": "ACTIVE", // ACTIVE, INACTIVE, BANNED
  "isOnline": true,
  "createdAt": ISODate("..."),
  "department_ids": [ 
    ObjectId("..."), // Ref to departments collection
    ObjectId("...") 
  ],
  "attributes": {
    "fullName": "نام کاربر",
    "permission_level": "admin"
  },
  "sessions": [
    {
      "token": "...",
      "createdAt": ISODate("..."),
      "expiresAt": ISODate("...")
    }
  ]
}
        
```

### 🏢 کالکشن دپارتمان‌ها (departments)

کالکشنی ساده برای تعریف تیم‌ها و گروه‌های کاری که کاربران به آن ارجاع داده می‌شوند.

```

{
  "_id": ObjectId("..."),
  "name": "پشتیبانی فنی",
  "description": "تیم مسئول پاسخگویی به مشکلات فنی کاربران"
}
        
```

### 💬 کالکشن چت‌ها (chats)

هر داکیومنت در این کالکشن یک مکالمه کامل با تمام پیام‌هایش است.

```

{
  "_id": ObjectId("..."),
  "title": "مشکل در ورود به سیستم",
  "status": "OPEN", // OPEN, CLOSED, PENDING
  "type": "TICKET", // TICKET, CHAT
  "participants": [
    { "user_id": ObjectId("..."), "role": "customer" },
    { "user_id": ObjectId("..."), "role": "operator" }
  ],
  "createdAt": ISODate("..."),
  "updatedAt": ISODate("..."),
  "endedAt": null,
  "messages": [
    {
      "_id": ObjectId("..."),
      "content": "سلام، من مشکل دارم.",
      "sender_id": ObjectId("..."),
      "createdAt": ISODate("..."),
      "isSystemMessage": false,
      "replyTo_id": null
    }
  ]
}
        
```

## 💾 کش کردن در Redis

برای افزایش عملکرد، داده‌هایی که زیاد خوانده می‌شوند باید در Redis کش شوند تا فشار از روی **MongoDB** برداشته شود. مهم‌ترین موارد عبارتند از:

*   **وضعیت آنلاین بودن کاربر (User Presence):** برای نمایش لحظه‌ای وضعیت کاربران.
*   **اطلاعات اپراتورهای در دسترس:** برای مسیریابی سریع چت‌های جدید.
*   **صف‌های پردازش پس‌زمینه (Background Job Queues):** برای مدیریت کارهای غیرهمزمان.

## 🔗 مدل‌سازی روابط در MongoDB

در MongoDB، روابط به دو روش اصلی مدل‌سازی می‌شوند:

*   **ادغام (Embedding):** برای روابط "یک به چند" که داده‌ها به هم وابستگی شدیدی دارند.  
    **مثال:** آرایه `messages` درون هر داکیومنت `chats` و آبجکت `attributes` درون هر داکیومنت `users`.
*   **ارجاع (Referencing):** برای روابط "چند به چند" یا زمانی که حجم داده‌های مرتبط زیاد است.  
    **مثال:** آرایه `department_ids` در داکیومنت `users` که به شناسه‌های کالکشن `departments` ارجاع می‌دهد.

این مستند در تاریخ ۱ سپتامبر ۲۰۲۵ به‌روزرسانی شده است.